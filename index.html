<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Client with Headers</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="card shadow-sm">
      <div class="card-header text-center">
        <h1 class="h4">WebSocket Client</h1>
      </div>
      <div class="card-body">
        <form>
          <div class="mb-3">
            <label for="serverUrl" class="form-label fw-bold">WebSocket Server URL</label>
            <input type="text" id="serverUrl" class="form-control" placeholder="ws://example.com:12345">
          </div>
          <div class="mb-3">
            <label for="authToken" class="form-label fw-bold">Authentication Token (Optional)</label>
            <input type="text" id="authToken" class="form-control" placeholder="Bearer <your-token>">
          </div>
          <div>
            <h5 class="mb-3">Custom Headers</h5>
            <div id="headersContainer"></div>
            <button type="button" id="addHeaderBtn" class="btn btn-outline-primary btn-sm">Add Header</button>
          </div>
          <div class="my-3 d-flex">
            <button type="button" id="connectBtn" class="btn btn-success ms-auto me-2">Connect</button>
            <button type="button" id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
          </div>
          <div class="mb-3">
            <label for="message" class="form-label fw-bold">Send Message</label>
            <textarea id="message" class="form-control" placeholder="Type your message here..."></textarea>
          </div>
          <button type="button" id="sendBtn" class="btn btn-primary w-100" disabled>Send</button>
        </form>
      </div>
      <div class="card-footer">
        <h5 class="mb-3">Logs</h5>
        <div id="log" class="bg-light border rounded p-3" style="height: 200px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let websocket;

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const serverUrl = document.getElementById('serverUrl');
    const authToken = document.getElementById('authToken');
    const message = document.getElementById('message');
    const log = document.getElementById('log');
    const addHeaderBtn = document.getElementById('addHeaderBtn');
    const headersContainer = document.getElementById('headersContainer');

    // Utility to log messages
    function logMessage(type, msg) {
      const entry = document.createElement('div');
      entry.classList.add('small', 'mb-2', type === 'info' ? 'text-primary' : type === 'sent' ? 'text-success' : type === 'received' ? 'text-info' : 'text-danger');
      entry.textContent = `[${type.toUpperCase()}] ${msg}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight; // Auto-scroll to the bottom
    }

    // Add a new header input row
    function addHeaderRow(key = '', value = '', selected = true) {
      const headerRow = document.createElement('div');
      headerRow.className = 'row align-items-center g-2 mb-2';

      const selectCol = document.createElement('div');
      selectCol.className = 'col-auto';
      const selectInput = document.createElement('input');
      selectInput.type = 'checkbox';
      selectInput.className = 'form-check-input';
      selectInput.checked = selected;
      selectCol.appendChild(selectInput);

      const keyCol = document.createElement('div');
      keyCol.className = 'col';
      const keyInput = document.createElement('input');
      keyInput.type = 'text';
      keyInput.className = 'form-control';
      keyInput.placeholder = 'Header Key';
      keyInput.value = key;
      keyCol.appendChild(keyInput);

      const valueCol = document.createElement('div');
      valueCol.className = 'col';
      const valueInput = document.createElement('input');
      valueInput.type = 'text';
      valueInput.className = 'form-control';
      valueInput.placeholder = 'Header Value';
      valueInput.value = value;
      valueCol.appendChild(valueInput);

      const deleteCol = document.createElement('div');
      deleteCol.className = 'col-auto';
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger btn-sm';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', () => {
        headersContainer.removeChild(headerRow);
      });
      deleteCol.appendChild(deleteBtn);

      headerRow.append(selectCol, keyCol, valueCol, deleteCol);
      headersContainer.appendChild(headerRow);
    }

    addHeaderBtn.addEventListener('click', () => {
      addHeaderRow();
    });

    // Collect selected headers
    function getHeaders() {
      const headers = {};
      const headerRows = headersContainer.querySelectorAll('.row');

      // check if there are any headers
      if (headerRows.length === 0) {
        return headers;
      }
      headerRows.forEach(row => {
        const selected = row.querySelector('input[type="checkbox"]').checked;
        const key = row.querySelector('input:nth-child(1)').value.trim();
        const value = row.querySelector('input:nth-child(2)').value.trim();
        if (selected && key && value) {
          headers[key] = value;
        }
      });
      return headers;
    }

    // Connect to WebSocket with authentication and headers
    connectBtn.addEventListener('click', () => {
      if (!serverUrl.value) {
        alert('Please enter a WebSocket server URL.');
        return;
      }

      const url = serverUrl.value.trim();
      const token = authToken.value.trim();
      const headers = getHeaders();

      try {
        if (token) headers['Authorization'] = token;

        const subprotocols = Object.entries(headers)
          .map(([key, value]) => `${key}: ${value}`)
          .join('; ');

        if (Object.keys(headers).length > 0) {
          websocket = new WebSocket(url, subprotocols);
        } else {
          websocket = new WebSocket(url);
        }

        websocket.onopen = () => {
          logMessage('info', 'Connected to WebSocket server.');
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          sendBtn.disabled = false;
        };

        websocket.onmessage = (event) => {
          logMessage('received', event.data);
        };

        websocket.onerror = () => {
          logMessage('error', 'An error occurred.');
        };

        websocket.onclose = () => {
          logMessage('info', 'Disconnected from WebSocket server.');
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          sendBtn.disabled = true;
        };
      } catch (error) {
        logMessage('error', `Failed to connect: ${error.message}`);
      }
    });

    // Disconnect from WebSocket
    disconnectBtn.addEventListener('click', () => {
      if (websocket) websocket.close();
    });

    // Send a message to WebSocket
    sendBtn.addEventListener('click', () => {
      if (!websocket || websocket.readyState !== WebSocket.OPEN) {
        alert('WebSocket is not connected.');
        return;
      }

      const msg = message.value;
      if (msg) {
        websocket.send(msg);
        logMessage('sent', msg);
        message.value = '';
      } else {
        alert('Please enter a message to send.');
      }
    });
  </script>
</body>
</html>
